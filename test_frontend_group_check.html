<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ†ç»„æ‰¹é‡æ£€æµ‹æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-warning { background-color: #ffc107; color: black; }
        .btn-success { background-color: #28a745; color: white; }
        .btn-danger { background-color: #dc3545; color: white; }
        .result {
            margin-top: 10px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 3px;
            white-space: pre-wrap;
        }
        .error { background-color: #f8d7da; color: #721c24; }
        .success { background-color: #d4edda; color: #155724; }
    </style>
</head>
<body>
    <h1>ğŸ§ª åˆ†ç»„æ‰¹é‡æ£€æµ‹æµ‹è¯•</h1>
    
    <div class="test-section">
        <h3>1. è®¤è¯æµ‹è¯•</h3>
        <button class="btn-primary" onclick="testAuth()">æµ‹è¯•ç™»å½•</button>
        <div id="authResult" class="result"></div>
    </div>
    
    <div class="test-section">
        <h3>2. è·å–åˆ†ç»„åˆ—è¡¨</h3>
        <button class="btn-success" onclick="testGetGroups()">è·å–åˆ†ç»„åˆ—è¡¨</button>
        <div id="groupsResult" class="result"></div>
    </div>
    
    <div class="test-section">
        <h3>3. åˆ†ç»„æ‰¹é‡æ£€æµ‹</h3>
        <button class="btn-warning" onclick="testBatchCheck()" id="batchCheckBtn" disabled>æ‰¹é‡æ£€æµ‹é»‘åå•</button>
        <div id="batchCheckResult" class="result"></div>
    </div>
    
    <div class="test-section">
        <h3>4. æŸ¥çœ‹æ£€æµ‹ç»“æœ</h3>
        <button class="btn-primary" onclick="testGetOrders()">æŸ¥çœ‹è®¢å•åˆ—è¡¨</button>
        <div id="ordersResult" class="result"></div>
    </div>

    <script>
        const API_BASE = 'http://127.0.0.1:8000/api/v1';
        let token = null;
        let selectedGroupId = null;

        async function testAuth() {
            const resultDiv = document.getElementById('authResult');
            resultDiv.textContent = 'æ­£åœ¨æµ‹è¯•è®¤è¯...';
            
            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username: 'admin',
                        password: 'admin123'
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    token = data.access_token;
                    resultDiv.textContent = `âœ… è®¤è¯æˆåŠŸ\nToken: ${token.substring(0, 20)}...`;
                    resultDiv.className = 'result success';
                } else {
                    resultDiv.textContent = `âŒ è®¤è¯å¤±è´¥: ${data.detail || 'æœªçŸ¥é”™è¯¯'}`;
                    resultDiv.className = 'result error';
                }
            } catch (error) {
                resultDiv.textContent = `âŒ è®¤è¯å¼‚å¸¸: ${error.message}`;
                resultDiv.className = 'result error';
            }
        }

        async function testGetGroups() {
            const resultDiv = document.getElementById('groupsResult');
            resultDiv.textContent = 'æ­£åœ¨è·å–åˆ†ç»„åˆ—è¡¨...';
            
            if (!token) {
                resultDiv.textContent = 'âŒ è¯·å…ˆè¿›è¡Œè®¤è¯';
                resultDiv.className = 'result error';
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/groups/list`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        skip: 0,
                        limit: 10,
                        status: 'active',
                        search: ''
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    resultDiv.textContent = `âœ… è·å–åˆ†ç»„æˆåŠŸ\nåˆ†ç»„æ•°é‡: ${data.data.length}\n\nåˆ†ç»„åˆ—è¡¨:\n${data.data.map(g => `- ${g.name} (ID: ${g.id}) - è®¢å•: ${g.total_orders}, å·²æ£€æµ‹: ${g.checked_orders}, åŒ¹é…: ${g.blacklist_matches}`).join('\n')}`;
                    resultDiv.className = 'result success';
                    
                    // è‡ªåŠ¨é€‰æ‹©20250914åˆ†ç»„
                    const targetGroup = data.data.find(g => g.name === '20250914');
                    if (targetGroup) {
                        selectedGroupId = targetGroup.id;
                        document.getElementById('batchCheckBtn').disabled = false;
                        resultDiv.textContent += `\n\nğŸ¯ è‡ªåŠ¨é€‰æ‹©åˆ†ç»„: ${targetGroup.name} (ID: ${targetGroup.id})`;
                    }
                } else {
                    resultDiv.textContent = `âŒ è·å–åˆ†ç»„å¤±è´¥: ${data.detail || 'æœªçŸ¥é”™è¯¯'}`;
                    resultDiv.className = 'result error';
                }
            } catch (error) {
                resultDiv.textContent = `âŒ è·å–åˆ†ç»„å¼‚å¸¸: ${error.message}`;
                resultDiv.className = 'result error';
            }
        }

        async function testBatchCheck() {
            const resultDiv = document.getElementById('batchCheckResult');
            resultDiv.textContent = 'æ­£åœ¨æ‰§è¡Œæ‰¹é‡æ£€æµ‹...';
            
            if (!token || !selectedGroupId) {
                resultDiv.textContent = 'âŒ è¯·å…ˆè¿›è¡Œè®¤è¯å’Œé€‰æ‹©åˆ†ç»„';
                resultDiv.className = 'result error';
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/groups/batch-check`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        group_id: selectedGroupId,
                        force_recheck: true
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    resultDiv.textContent = `âœ… æ‰¹é‡æ£€æµ‹æˆåŠŸ!\n\næ£€æµ‹ç»“æœ:\n- åˆ†ç»„åç§°: ${data.group_name}\n- æ€»è®¢å•æ•°: ${data.total_orders}\n- å·²æ£€æµ‹è®¢å•: ${data.checked_orders}\n- é»‘åå•åŒ¹é…: ${data.blacklist_matches}\n- æ–°å‘ç°åŒ¹é…: ${data.new_matches}\n- æ£€æµ‹çŠ¶æ€: ${data.status}\n- æ£€æµ‹æ—¶é—´: ${data.check_time}\n- è¯¦ç»†ä¿¡æ¯: ${data.message}`;
                    resultDiv.className = 'result success';
                } else {
                    resultDiv.textContent = `âŒ æ‰¹é‡æ£€æµ‹å¤±è´¥: ${data.detail || 'æœªçŸ¥é”™è¯¯'}`;
                    resultDiv.className = 'result error';
                }
            } catch (error) {
                resultDiv.textContent = `âŒ æ‰¹é‡æ£€æµ‹å¼‚å¸¸: ${error.message}`;
                resultDiv.className = 'result error';
            }
        }

        async function testGetOrders() {
            const resultDiv = document.getElementById('ordersResult');
            resultDiv.textContent = 'æ­£åœ¨è·å–è®¢å•åˆ—è¡¨...';
            
            if (!token || !selectedGroupId) {
                resultDiv.textContent = 'âŒ è¯·å…ˆè¿›è¡Œè®¤è¯å’Œé€‰æ‹©åˆ†ç»„';
                resultDiv.className = 'result error';
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/orders/list`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        group_id: selectedGroupId,
                        skip: 0,
                        limit: 10,
                        group_tour_number: '',
                        orderer: '',
                        contact_phone: '',
                        order_status: '',
                        is_blacklist_checked: ''
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    resultDiv.textContent = `âœ… è·å–è®¢å•æˆåŠŸ!\n\nè®¢å•æ•°é‡: ${data.data.length}\næ€»è®¢å•æ•°: ${data.total}\n\nå‰10æ¡è®¢å•:\n${data.data.map((o, i) => `${i+1}. ID: ${o.id}, ä¸‹å•äºº: ${o.orderer}, ç”µè¯: ${o.contact_phone}, å·²æ£€æµ‹: ${o.is_blacklist_checked}, é£é™©ç­‰çº§: ${o.blacklist_risk_level}, åŒ¹é…ä¿¡æ¯: ${o.blacklist_match_info || 'N/A'}`).join('\n')}`;
                    resultDiv.className = 'result success';
                } else {
                    resultDiv.textContent = `âŒ è·å–è®¢å•å¤±è´¥: ${data.detail || 'æœªçŸ¥é”™è¯¯'}`;
                    resultDiv.className = 'result error';
                }
            } catch (error) {
                resultDiv.textContent = `âŒ è·å–è®¢å•å¼‚å¸¸: ${error.message}`;
                resultDiv.className = 'result error';
            }
        }
    </script>
</body>
</html>
